#!/bin/bash

# Log and HTML output files
LOG_FILE="execution_log_$(date '+%Y%m%d_%H%M%S').txt"
HTML_FILE="final_output.html"

# Email configuration
EMAIL_RECIP="abhisha3@amdocs.com"
EMAIL_FROM="noreplyreports@amdocs.com"
EMAIL_SUBJECT="Report || RELEASE PONR flag not released by the System"

# PostgreSQL connection string
CONN_STR="postgresql://ossdb01uams:Pr0d_ossdb01uams@oso-pstgr-rd.orion.comcast.com:6432/prodossdb"

# Logging function
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$LOG_FILE"
}

# Execute SQL and save to HTML
run_query() {
    local start=$1
    local end=$2
    local output=$3

    local sql="
SELECT ord.entity_name AS \"Activty Name\",
       oai.spec_ver_id AS \"Spec Id\",
       aocd.interface AS Interface,
       SUM(CASE
               WHEN oai.actual_start_date >= NOW() - INTERVAL '1 days'
                    AND oai.actual_start_date < NOW()
               THEN 1 ELSE 0
           END) AS \"less than 24 hours\"
FROM ossdb01db.oss_activity_instance oai,
     ossdb01ref.oss_ref_attribute ora,
     ossdb01ref.oss_ref_data ord,
     ossdb01db.activity_overview_custom_data aocd
WHERE oai.part_id BETWEEN $start AND $end
  AND oai.last_update_date > NOW() - INTERVAL '1 days'
  AND oai.state IN ('In Progress', 'Rework In Progress')
  AND oai.is_latest_version = 1
  AND oai.implementation_type <> 'Manual'
  AND oai.spec_ver_id = ora.attribute_value
  AND ora.entity_id = ord.entity_id
  AND oai.spec_ver_id = aocd.spec_id
  AND oai.spec_ver_id NOT IN (
      'f1f62e0d-6f07-4c0c-be12-631e07b7448f','3936695f-90a1-4e79-8a60-1b460fcf26b4',
      '85a4f2c9-c720-4f30-bd84-408a36da97c2','20e2328d-f681-4c4a-bdad-43ad9da2b728',
      'bf25901d-eb35-48b8-b4ad-ba39d874cbc4','d30f36e7-c671-471b-aa70-bb5ccbe8939f',
      'b0403ef6-3198-4641-8d11-7630361473b9','4bd19612-5446-4f70-bb85-e05b8bcbc9da',
      '546d9598-8d49-4fb9-b2b7-f11ac62ac1c5','2316fc59-1289-4fbf-ba10-e933cdfd9941',
      '2f4a4d90-bccd-43e4-851f-e70073b1da6a','81c7f66d-a2fc-4d89-bc96-d83ebf70b11c',
      'b0012a40-d80f-4a1e-83ce-d78455d21fdc','b4b7b8c9-e275-409d-8657-0c5ffbb28e59',
      '2580eed6-e91b-497e-9504-dd289765eb03','22a7a5a0-fc32-4af0-a929-08aa860c3c4b',
      '0d409cea-5222-45f5-ae88-109c20919bfb','811131f6-8b6b-4548-a535-8708666d1dda',
      'b5bad4ff-7935-4053-afb5-fb1d25797a44','127ecdcc-b677-4132-a95b-c509cfaa7c60',
      'a4267bbb-c25a-4d93-a7c7-3d96c579b895','1aea0862-2530-43c8-9fb0-dc120166f7f4',
      '0c81c4e0-2681-476f-b7d1-bcf14b829265','fb5043db-c056-4529-be38-db0c1bae3f20',
      'e6880c45-1cbd-4d7a-8c4a-044e667ecda5','e3a7de55-7a84-499d-8cc1-9d227d7c357f',
      '330116f0-e475-4afa-b949-697ac94b0d52','02b9b6b8-44eb-4652-b137-de7d5530416f',
      '3f9849dd-5133-46f2-a789-80a21120554e','09d7e394-39b9-4ef0-b747-bc5eeda5d9fd',
      '7597cb49-d972-4e98-b3f1-84687d4360f5','1287e89f-056b-4c3c-a2a7-e200a012bc92',
      '24e86c2a-6cb5-4e0e-ab11-e00dd14da5e4','f2a616fd-ccb0-4b1f-b413-fc915802fa25',
      '8a112601-d9f2-4d33-ab00-19f4f483104b','88f0860f-e647-41cd-aaac-1930adea8a3c',
      '92286b75-55c8-4991-be47-c04c7b3d9780','fddff199-92dc-4862-b90e-6c2bf32efcda',
      'b9e64a57-b511-4b1c-8eb7-c3d7e9feff25','55c4d13b-19d2-45a9-b1b7-a1b9e874aaff',
      '54d3e8c0-4a06-41bc-b7cf-1749177e9ff1','ce922024-75d4-4af5-9b4e-2e8d6d79f3e2',
      '7277a8b5-9eef-4421-bf4b-06b8494e91c9','bb73d434-f14e-4349-b080-83f747900676',
      '6a0bd4cf-8b31-499b-b331-378beb30a2b9','60fa385f-6e81-43e2-b129-08d72aaa5fc7',
      '776d2d5b-c7fe-49d1-a071-fd4472964c1e'
  )
GROUP BY ord.entity_name, oai.spec_ver_id, aocd.interface
ORDER BY \"less than 24 hours\" DESC;
"

    log "Running query for part_id BETWEEN $start AND $end"
    start_time=$(date +%s)
    psql "$CONN_STR" -H -c "$sql" -o "$output"
    if [[ $? -ne 0 ]]; then
        log "Query failed for part_id BETWEEN $start AND $end"
    else
        log "Query succeeded for part_id BETWEEN $start AND $end"
    fi
    end_time=$(date +%s)
    log "Execution time: $((end_time - start_time)) seconds"
}

# Run queries in 10 parts
log "Starting SQL execution in 10 parts"
step=10
for i in {0..9}; do
    start=$((i * step + 1))
    end=$((start + step - 1))
    run_query $start $end "part_$i.html"
done



# Merge HTML tables
log "Merging HTML outputs"
echo "<html><body>" > $HTML_FILE
echo "<p>Hi Team,</p>" >> $HTML_FILE
echo "<p>Please find below the list of orders where the RELEASE PONR flag was not triggered by the system, even though the mandatory wait period associated with the Registered Timed Action has been completed.</p>" >> $HTML_FILE
echo "<p>Kindly review these orders and take the necessary corrective actions. This issue is impacting the business, as services have already been ceased at the customer sites, but billing continues to be active.</p>" >> $HTML_FILE
echo "<table border='1'>" >> $HTML_FILE

for file in part_*.html; do
    if [[ -f "$file" ]]; then
        if [[ "$file" == "part_0.html" ]]; then
            grep -A 1000 "<table" "$file" | grep -B 1000 "</table" >> $HTML_FILE
        else
            grep "<tr>" "$file" | grep -v "<th>" >> $HTML_FILE
        fi
    else
        log "Missing file: $file"
    fi
done

echo "</table>" >> $HTML_FILE
echo "<div class='note'>For any changes in the report: Please reach out to <a href='mailto:abhisha3@amdocs.com'>abhisha3@amdocs.com</a></div>" >> $HTML_FILE
echo "<div class='footer'>Regards,<br>Abhishek Agrahari</div>" >> $HTML_FILE
echo "</body></html>" >> $HTML_FILE

# Send email
log "Sending email"
cat <<EOF | /usr/sbin/sendmail -t
To: $EMAIL_RECIP
From: $EMAIL_FROM
Subject: $EMAIL_SUBJECT
Content-Type: text/html

$(cat $HTML_FILE)
EOF

log "Script completed successfully"

