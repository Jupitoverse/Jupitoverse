<div class="page">
    <h1>üìã SR Handling</h1>
    <p class="subtitle">Upload, manage, and track SR assignments across the team</p>

    <!-- Upload Section -->
    <div class="sr-upload-section">
        <h2>üì§ Upload SR Data</h2>
        <div class="upload-container">
            <div class="upload-box" onclick="document.getElementById('sr-file-input').click()">
                <div class="upload-icon">üìÅ</div>
                <h3>Click to Upload Excel File</h3>
                <p>Supported formats: .xlsx, .xls, .csv</p>
                <input type="file" id="sr-file-input" accept=".xlsx,.xls,.csv" style="display: none;" onchange="handleFileUpload(event)">
            </div>
            <div class="upload-info">
                <h3>Upload Instructions:</h3>
                <ul>
                    <li>‚úÖ Excel file should contain SR ID, Customer ID, Description, Priority</li>
                    <li>‚úÖ File will be processed and displayed in the dashboard below</li>
                    <li>‚úÖ You can then assign SRs to team members</li>
                    <li>‚úÖ Status can be updated manually for tracking</li>
                </ul>
                <button class="primary-btn" onclick="downloadTemplate()">
                    üì• Download Template
                </button>
            </div>
        </div>
    </div>

    <!-- Assignment Section -->
    <div class="sr-assignment-section" style="margin-top: 40px;">
        <h2>üë• Team Members</h2>
        <div class="team-members-grid">
            <div class="team-member-card" data-member="Abhishek">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Abhishek</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Smitesh">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Smitesh</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Akshit">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Akshit</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Anamika">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Anamika</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Sagar">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Sagar</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Harsh">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Harsh</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Aditya">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Aditya</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Varnikha">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Varnikha</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Nikhilesh">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Nikhilesh</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Prateek">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Prateek</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Aman">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Aman</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Anvesh">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Anvesh</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Saurabh">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Saurabh</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Mukul">
                <div class="member-avatar">üë§</div>
                <div class="member-name">Mukul</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Site_Team">
                <div class="member-avatar">üë•</div>
                <div class="member-name">Site Team</div>
                <div class="member-count">0 SRs</div>
            </div>
            <div class="team-member-card" data-member="Other">
                <div class="member-avatar">‚ùì</div>
                <div class="member-name">Other</div>
                <div class="member-count">0 SRs</div>
            </div>
        </div>
    </div>

    <!-- SR Dashboard -->
    <div class="sr-dashboard-section" style="margin-top: 40px;">
        <div class="dashboard-header">
            <h2>üìä SR Dashboard</h2>
            <div class="dashboard-actions">
                <button class="secondary-btn" onclick="autoAssignSRs()">
                    ü§ñ Auto Assign (Round Robin)
                </button>
                <button class="secondary-btn" onclick="clearAllAssignments()">
                    üîÑ Clear All Assignments
                </button>
                <button class="primary-btn" onclick="exportSRData()">
                    üìä Export to Excel
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="sa-search-engine" style="margin-top: 20px;">
            <div class="sa-filter-group">
                <label for="assignee-filter">Assigned To:</label>
                <select id="assignee-filter" class="filter-input" onchange="filterSRData()">
                    <option value="">All</option>
                    <option value="Unassigned">Unassigned</option>
                    <option value="Abhishek">Abhishek</option>
                    <option value="Smitesh">Smitesh</option>
                    <option value="Akshit">Akshit</option>
                    <option value="Anamika">Anamika</option>
                    <option value="Sagar">Sagar</option>
                    <option value="Harsh">Harsh</option>
                    <option value="Aditya">Aditya</option>
                    <option value="Varnikha">Varnikha</option>
                    <option value="Nikhilesh">Nikhilesh</option>
                    <option value="Prateek">Prateek</option>
                    <option value="Aman">Aman</option>
                    <option value="Anvesh">Anvesh</option>
                    <option value="Saurabh">Saurabh</option>
                    <option value="Mukul">Mukul</option>
                    <option value="Site_Team">Site Team</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="sa-filter-group">
                <label for="status-filter-sr">Status:</label>
                <select id="status-filter-sr" class="filter-input" onchange="filterSRData()">
                    <option value="">All</option>
                    <option value="New">New</option>
                    <option value="In Progress">In Progress</option>
                    <option value="On Hold">On Hold</option>
                    <option value="Resolved">Resolved</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="sa-filter-group primary" style="flex: 2;">
                <input type="text" id="sr-search" class="filter-input" placeholder="üîç Search SR ID, Customer ID, Description..." oninput="filterSRData()">
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container" style="margin-top: 20px;">
            <div id="sr-table-container">
                <table id="sr-table" class="data-table">
                    <thead id="sr-table-head">
                        <tr>
                            <th>Loading...</th>
                        </tr>
                    </thead>
                    <tbody id="sr-tbody">
                        <tr>
                            <td colspan="10" class="no-data">Loading SR data from Ultron.xls...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.sr-upload-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 30px;
}
.upload-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-top: 20px;
}
.upload-box {
    border: 3px dashed var(--border-primary);
    border-radius: 12px;
    padding: 60px 40px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
}
.upload-box:hover {
    border-color: var(--accent-primary);
    background: rgba(139, 92, 246, 0.05);
}
.upload-icon {
    font-size: 4rem;
    margin-bottom: 20px;
}
.upload-box h3 {
    color: var(--text-primary);
    margin-bottom: 10px;
}
.upload-box p {
    color: var(--text-secondary);
}
.upload-info {
    background: rgba(139, 92, 246, 0.05);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 30px;
}
.upload-info h3 {
    color: var(--accent-primary);
    margin-bottom: 15px;
}
.upload-info ul {
    list-style: none;
    padding: 0;
    margin-bottom: 20px;
}
.upload-info li {
    color: var(--text-secondary);
    padding: 8px 0;
    line-height: 1.6;
}
.sr-assignment-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 30px;
}
.team-members-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 20px;
    margin-top: 20px;
}
.team-member-card {
    background: rgba(139, 92, 246, 0.05);
    border: 2px solid var(--border-primary);
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    transition: all 0.3s;
    cursor: pointer;
}
.team-member-card:hover {
    border-color: var(--accent-primary);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px var(--shadow-color);
}
.member-avatar {
    font-size: 3rem;
    margin-bottom: 12px;
}
.member-name {
    color: var(--text-primary);
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 8px;
}
.member-count {
    color: var(--accent-primary);
    font-weight: 700;
    font-size: 1.2rem;
}
.sr-dashboard-section {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 12px;
    padding: 30px;
}
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.dashboard-actions {
    display: flex;
    gap: 10px;
}
.data-table {
    width: 100%;
    border-collapse: collapse;
}
.data-table th {
    background: rgba(139, 92, 246, 0.1);
    color: var(--accent-primary);
    padding: 12px;
    text-align: left;
    font-weight: 600;
}
.data-table td {
    padding: 12px;
    border-bottom: 1px solid var(--border-primary);
    color: var(--text-primary);
}
.data-table tbody tr:hover {
    background: rgba(139, 92, 246, 0.05);
}
.no-data {
    text-align: center;
    padding: 40px !important;
    color: var(--text-secondary);
}
.badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}
.badge-high {
    background: rgba(239, 68, 68, 0.2);
    color: #f87171;
}
.badge-medium {
    background: rgba(245, 158, 11, 0.2);
    color: #fbbf24;
}
.badge-low {
    background: rgba(16, 185, 129, 0.2);
    color: #34d399;
}
.action-btn {
    background: var(--accent-gradient);
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-right: 5px;
    font-size: 0.85rem;
}
@media (max-width: 768px) {
    .upload-container, .dashboard-header {
        grid-template-columns: 1fr;
        flex-direction: column;
        gap: 15px;
    }
}
</style>

<script>
let srData = [];
let filteredSRData = [];

let srColumns = [];

document.addEventListener('pageLoaded', function(e) {
    if (e.detail.pageId === 'sr-handling') {
        loadSRDataFromExcel();
    }
});

async function loadSRDataFromExcel() {
    try {
        const response = await fetch(`${API_BASE_URL}/api/excel/sr-handling-data`);
        const result = await response.json();
        
        if (result.success) {
            srData = result.data;
            srColumns = result.columns;
            
            // Load any saved assignments/status from localStorage
            const saved = localStorage.getItem('srDataAssignments');
            if (saved) {
                const assignments = JSON.parse(saved);
                // Merge saved assignments with loaded data
                srData.forEach((sr, index) => {
                    if (assignments[index]) {
                        sr.Assignee = assignments[index].Assignee || '';
                        sr.Status = assignments[index].Status || 'New';
                    }
                });
            }
            
            filteredSRData = srData;
            renderSRData();
            updateTeamCounts();
            alert(`Loaded ${srData.length} SR records from Ultron.xls`);
        } else {
            alert('Error loading SR data: ' + result.error);
        }
    } catch (error) {
        console.error('Error loading SR data:', error);
        document.getElementById('sr-tbody').innerHTML = '<tr><td colspan="10" class="no-data">Error loading data. Please try again.</td></tr>';
    }
}

function handleFileUpload(event) {
    // Reload data from Excel file
    loadSRDataFromExcel();
}

function loadSRData() {
    // This is called on page load
    // Actual loading happens in loadSRDataFromExcel()
}

const teamMembers = ['Abhishek', 'Smitesh', 'Akshit', 'Anamika', 'Sagar', 'Harsh', 'Aditya', 'Varnikha', 'Nikhilesh', 'Prateek', 'Aman', 'Anvesh', 'Saurabh', 'Mukul', 'Site_Team', 'Other'];

function renderSRData() {
    const thead = document.getElementById('sr-table-head');
    const tbody = document.getElementById('sr-tbody');
    
    if (filteredSRData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="no-data">No SR data found</td></tr>';
        return;
    }

    // Generate table headers dynamically from columns
    const displayColumns = srColumns.filter(col => !['Assignee', 'Status'].includes(col)).slice(0, 6); // First 6 columns from Excel
    thead.innerHTML = '<tr>' + 
        displayColumns.map(col => `<th>${col}</th>`).join('') + 
        '<th>Assigned To</th><th>Status</th><th>Actions</th></tr>';

    // Generate table rows
    tbody.innerHTML = filteredSRData.map((sr, index) => {
        const cells = displayColumns.map(col => {
            const value = sr[col] || '';
            return `<td>${String(value).substring(0, 50)}${String(value).length > 50 ? '...' : ''}</td>`;
        }).join('');
        
        const assigneeOptions = teamMembers.map(member => 
            `<option value="${member}" ${sr.Assignee === member ? 'selected' : ''}>${member}</option>`
        ).join('');
        
        return `<tr>
            ${cells}
            <td>
                <select class="filter-input" style="width: 130px;" onchange="assignSR(${index}, this.value)">
                    <option value="" ${!sr.Assignee || sr.Assignee === '' ? 'selected' : ''}>Unassigned</option>
                    ${assigneeOptions}
                </select>
            </td>
            <td>
                <select class="filter-input" style="width: 120px;" onchange="updateStatus(${index}, this.value)">
                    <option value="New" ${sr.Status === 'New' ? 'selected' : ''}>New</option>
                    <option value="In Progress" ${sr.Status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                    <option value="On Hold" ${sr.Status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                    <option value="Resolved" ${sr.Status === 'Resolved' ? 'selected' : ''}>Resolved</option>
                    <option value="Closed" ${sr.Status === 'Closed' ? 'selected' : ''}>Closed</option>
                </select>
            </td>
            <td>
                <button class="action-btn" onclick="viewSR(${index})">üëÅÔ∏è View</button>
            </td>
        </tr>`;
    }).join('');

    updateTeamCounts();
    saveSRData();
}

function assignSR(index, assignee) {
    srData[index].Assignee = assignee;
    filterSRData();
}

function updateStatus(index, status) {
    srData[index].Status = status;
    saveSRData();
}

function autoAssignSRs() {
    let memberIndex = 0;
    
    srData.forEach(sr => {
        if (!sr.Assignee || sr.Assignee === '') {
            sr.Assignee = teamMembers[memberIndex];
            memberIndex = (memberIndex + 1) % teamMembers.length;
        }
    });
    
    filterSRData();
    alert('SRs auto-assigned using Round Robin method!');
}

function clearAllAssignments() {
    if (confirm('Clear all SR assignments?')) {
        srData.forEach(sr => sr.Assignee = '');
        filterSRData();
    }
}

function filterSRData() {
    const assigneeFilter = document.getElementById('assignee-filter')?.value || '';
    const statusFilter = document.getElementById('status-filter-sr')?.value || '';
    const searchTerm = document.getElementById('sr-search')?.value.toLowerCase() || '';
    
    filteredSRData = srData.filter(sr => {
        if (assigneeFilter === 'Unassigned' && sr.Assignee && sr.Assignee !== '') return false;
        if (assigneeFilter && assigneeFilter !== 'Unassigned' && sr.Assignee !== assigneeFilter) return false;
        if (statusFilter && sr.Status !== statusFilter) return false;
        if (searchTerm) {
            const srStr = Object.values(sr).join(' ').toLowerCase();
            if (!srStr.includes(searchTerm)) return false;
        }
        return true;
    });
    
    renderSRData();
}

function updateTeamCounts() {
    document.querySelectorAll('.team-member-card').forEach(card => {
        const member = card.dataset.member;
        const count = srData.filter(sr => sr.Assignee === member).length;
        card.querySelector('.member-count').textContent = `${count} SRs`;
    });
}

function saveSRData() {
    // Save only assignments and status to localStorage
    const assignments = srData.map(sr => ({
        Assignee: sr.Assignee || '',
        Status: sr.Status || 'New'
    }));
    localStorage.setItem('srDataAssignments', JSON.stringify(assignments));
}

function viewSR(index) {
    const sr = srData[index];
    const details = Object.entries(sr).map(([key, value]) => `${key}: ${value}`).join('\n');
    alert(`SR Details:\n\n${details}`);
}

function downloadTemplate() {
    const template = 'SR ID,Customer ID,Description,Priority,Assigned To,Status,Created Date\nSR-XXXXX,123456789,Issue description here,High,,New,2025-01-20';
    const blob = new Blob([template], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sr_template.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function exportSRData() {
    if (srData.length === 0) {
        alert('No data to export');
        return;
    }
    
    const headers = ['SR ID', 'Customer ID', 'Description', 'Priority', 'Assigned To', 'Status', 'Created Date'];
    const csvContent = [
        headers.join(','),
        ...srData.map(sr => 
            `${sr.srId},${sr.customerId},"${sr.description}",${sr.priority},${sr.assignedTo || 'Unassigned'},${sr.status},${sr.createdDate}`
        )
    ].join('\n');
    
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sr_data_export_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>

